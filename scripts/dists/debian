mirror="http://http.debian.net/debian/"
release="stable"
deboot_version="1.0.67"

# Debootstrap uses a different name for the arch.
[ "$arch" = "x86_64" ] && arch="amd64"

# Fix the shell
echo "/bin/bash --init-file /etc/profile" > "$tmpdir/shell"

# Download and extract needed things
deboot_name="debootstrap_${deboot_version}_all.deb"
[ ! -f "$tmpdir/$deboot_name" ] && curl -L "$mirror/pool/main/d/debootstrap/$deboot_name" -o "$tmpdir/$deboot_name"

mkdir -p "$tmpdir/tools"
sh -c "cd '$tmpdir' && ar x '$deboot_name' data.tar.gz"
tar xf "$tmpdir/data.tar.gz" -C "$tmpdir/tools"

# Set up the chroot with debootstrap
sudo DEBOOTSTRAP_DIR="$tmpdir/tools/usr/share/debootstrap" "$tmpdir/tools/usr/sbin/debootstrap" --arch "$arch" "$release" "$distdir" "$mirror"

# Fix the permissions
sudo chown -R $(id -u).$(id -g) "$distdir"
